import os
import json
import textwrap
from dataclasses import dataclass, field
from typing import List
from openai import OpenAI
from dotenv import load_dotenv

# --- 1. å‡†å¤‡å·¥ä½œï¼šåŠ è½½ API å¯†é’¥å¹¶åˆå§‹åŒ–å®¢æˆ·ç«¯ ---
from config.secret import GEMINI_KEY
from google import genai

# setup_proxy()
from core.agent import simulate_turn, observe
from core.model import call_model
from entity.creature import AgentMonster
from memory.valhalla import summon_from_valhalla
from prompt.prompt import create_creature_system_prompt

os.environ["HTTP_PROXY"] = "http://127.0.0.1:7890"
os.environ["HTTPS_PROXY"] = "http://127.0.0.1:7890"

client = OpenAI(
    api_key=GEMINI_KEY,
    base_url="https://generativelanguage.googleapis.com/v1beta/openai/"
)


def create_monster(query: str) -> AgentMonster:
    creature = call_model(system_prompt=create_creature_system_prompt,
                          user_prompt=query,
                          output_schema_class=AgentMonster)
    creature.init_basic_status()
    return creature


## https://open.spotify.com/track/4LsLiCvF7whO3wNqgqS8Mo?si=337440aaef174b25


# --- 4. ä¸»ç¨‹åºï¼šåˆ›å»º Agent å¹¶å¼€å§‹æ¨¡æ‹Ÿ ---
if __name__ == "__main__":
    summon_spell = summon_from_valhalla("r")
    player = create_monster(summon_spell)
    print(player.to_json)

    saber = create_monster(summon_from_valhalla("saber"))
    print(saber.to_json)

    # berserker = create_monster(summon_from_valhalla("jotaro"))
    # print(berserker.to_json)

    print("--- æ¬¢è¿æ¥åˆ° LLM Agent Monster æˆ˜æ–—æ¨¡æ‹Ÿå™¨ MVP ---")

    game_environment = "è¿™æ˜¯ä¸€ä¸ªç°ä»£éƒ½å¸‚çš„å…¬å›­é‡Œã€‚å…¬å›­æœ‰è·¯ç¯ã€ç§‹åƒã€æ²™å‘ã€æ»‘æ¢¯å’Œè··è··æ¿ã€‚å‘¨å›´æœ‰è‡ªåŠ¨å”®è´§æœºã€‚"

    # åˆå§‹åŒ–æˆ˜æ–—
    game_history = []
    active_agent, opponent = player, saber

    print("\n[æˆ˜æ–—å¼€å§‹!]")
    print(f"ç¯å¢ƒ: {game_environment}")
    print(f"å¯¹æˆ˜åŒæ–¹: {active_agent.name} vs {opponent.name}")
    print("-" * 20)

    observation = ""
    # æ¨¡æ‹Ÿ 10 ä¸ªå›åˆ
    for turn in range(1, 20):
        print(f"--- ç¬¬ {turn} å›åˆ ---")


        observation = observe(active_agent, game_environment, game_history, observation)

        # æ ¸å¿ƒï¼šè°ƒç”¨ LLM æ¨¡æ‹Ÿä¸€å›åˆ
        action_result = simulate_turn(active_agent, opponent, game_environment, game_history[-4:])  # åªä¼ é€’æœ€è¿‘2æ¡å†å²è®°å½•

        # æ‰“å°ç»“æœ
        print(f"ğŸ§  [{active_agent.name} çš„æƒ³æ³•]: {action_result.get('thought', 'æ— ')}")
        print(f"âš”ï¸ [{active_agent.name} çš„è¡ŒåŠ¨]: {action_result['action']}")
        print(f"ë¬˜ [{action_result['description']}]")

        if action_result["mana_cost"]:
            active_agent.mp -= action_result["mana_cost"]
        if action_result["power"]:
            opponent.hp -= action_result["power"]

        # æ›´æ–°å†å²è®°å½•
        game_history.append(f"ç¬¬{turn}å›åˆ, {active_agent.name}: {action_result['description']}")
        print(f"HP: {active_agent.hp} / MP: {active_agent.mp}")

        if opponent.hp <= 0:
            print(f"{active_agent.name} èƒœåˆ©ã€‚")
            break


        # äº¤æ¢è¡ŒåŠ¨æ–¹
        active_agent, opponent = opponent, active_agent

    print("\n--- æ¨¡æ‹Ÿç»“æŸ ---")

# EXAMPLE
"""
[æˆ˜æ–—å¼€å§‹!]
ç¯å¢ƒ: è¿™æ˜¯ä¸€ä¸ªç°ä»£éƒ½å¸‚çš„å…¬å›­é‡Œã€‚å…¬å›­æœ‰è·¯ç¯ã€ç§‹åƒã€æ²™å‘ã€æ»‘æ¢¯å’Œè··è··æ¿ã€‚å‘¨å›´æœ‰è‡ªåŠ¨å”®è´§æœºã€‚
å¯¹æˆ˜åŒæ–¹: R vs é˜¿å°”æ‰˜è‰é›…Â·æ½˜å¾·æ‹‰è´¡
--------------------
--- ç¬¬ 1 å›åˆ ---

[ç³»ç»Ÿ] æ­£åœ¨ä¸º R æ€è€ƒè¡ŒåŠ¨...
ğŸ§  [R çš„æƒ³æ³•]: é˜¿å°”æ‰˜è‰é›…æ‹¥æœ‰å¼ºå¤§çš„'å¯¹é­”åŠ›'ï¼Œè¿™ä½¿å¾—çº¯ç²¹çš„å†°ç³»é­”æ³•æ”»å‡»æ•ˆç‡ä½ä¸‹ã€‚ä½œä¸ºä¸€åç²¾é€šå‰‘æœ¯çš„å†’é™©è€…ï¼Œæˆ‘åº”è¯¥åˆ©ç”¨æˆ‘çš„å†°åˆƒå’Œæ•æ·ä¼˜åŠ¿è¿›è¡Œç‰©ç†æ”»å‡»ï¼ŒåŒæ—¶è¾…ä»¥å†°ç³»åŠ›é‡å¼ºåŒ–å¨åŠ›ã€‚'å†°åˆƒå‡èš'èƒ½ä»¥æä½çš„æ¶ˆè€—å¢å¼ºæˆ‘çš„ä¸»æ­¦å™¨ï¼Œè¿™æ—¢èƒ½é€ æˆæœ‰æ•ˆä¼¤å®³ï¼Œåˆèƒ½ä¿å­˜MPä»¥åº”å¯¹åç»­æˆ˜å†µï¼Œæ¯”å¦‚ä½¿ç”¨'å¯’å†°æŠ¤ç”²'è¿›è¡Œé˜²å¾¡ï¼Œæˆ–æ˜¯'æå¯’è‡ªæ„ˆ'æ¢å¤ä¼¤åŠ¿ã€‚åˆæ¬¡äº¤é”‹ï¼Œæˆ‘éœ€è¦è¯•æ¢å¥¹çš„çœŸå®å®åŠ›å’Œ'é£ç‹ç»“ç•Œ'çš„èŒƒå›´ã€‚
âš”ï¸ [R çš„è¡ŒåŠ¨]: ç–¾é£å†°æ–©
ë¬˜ [Rçš„çœ¼ç¥å¦‚å†°æ™¶èˆ¬é”åˆ©ï¼Œä»–èº«å½¢ä¸€é—ªï¼Œæ•æ·åœ°è·ƒå‘é˜¿å°”æ‰˜è‰é›…ã€‚ç©ºæ°”ä¸­çš„æ°´æ±½åœ¨ä»–æ‰‹ä¸­è¿…é€Ÿå‡èšï¼ŒåŒ–ä½œä¸€é“é”‹åˆ©çš„å†°åˆƒï¼Œå…¶å¨åŠ›åœ¨ç¬é—´å¾—åˆ°å¼ºåŒ–ã€‚ä»–å‡­å€Ÿç²¾æ¹›çš„å‰‘æœ¯ï¼Œå°†å†°åˆƒåŒ–ä¸ºä¸€é“å¸¦ç€å½»éª¨å¯’æ„çš„æµå…‰ï¼Œç›´å–å¯¹æ‰‹ã€‚è¿™è¿…ç–¾è€Œç²¾å‡†çš„ä¸€å‡»ï¼Œè¯•å›¾ç©¿é€é£ç‹ç»“ç•Œçš„é˜»ç¢ã€‚]
--- ç¬¬ 2 å›åˆ ---

[ç³»ç»Ÿ] æ­£åœ¨ä¸º é˜¿å°”æ‰˜è‰é›…Â·æ½˜å¾·æ‹‰è´¡ æ€è€ƒè¡ŒåŠ¨...
ğŸ§  [é˜¿å°”æ‰˜è‰é›…Â·æ½˜å¾·æ‹‰è´¡ çš„æƒ³æ³•]: Råœ¨ä¸Šä¸€å›åˆå¯¹æˆ‘å‘åŠ¨äº†æ”»å‡»ï¼Œè™½ç„¶é£ç‹ç»“ç•Œæœ‰æ•ˆæŠµå¾¡ï¼Œä½†æˆ‘ä¹Ÿéœ€è¦ç»™äºˆå›å‡»ã€‚ç°åœ¨å¹¶éä½¿ç”¨å®å…·çš„æœ€å¥½æ—¶æœºï¼ŒRçš„ç”Ÿå‘½å€¼å°šé«˜ï¼Œè€Œæˆ‘çš„MPéœ€è¦ç•™å­˜ã€‚ä½œä¸ºéª‘å£«ï¼Œæˆ‘æ“…é•¿çš„æ˜¯ç›´æ¥è€Œå¼ºåŠ›çš„å‰‘æœ¯ã€‚åˆ©ç”¨é£ç‹ç»“ç•Œçš„éšåŒ¿ä¼˜åŠ¿ï¼Œæˆ‘å¯ä»¥å‘åŠ¨ä¸€æ¬¡å‡ºå…¶ä¸æ„çš„è¿…æ·æ–©å‡»ï¼Œæ—¢èƒ½æ¶ˆè€—å¯¹æ‰‹ï¼Œåˆèƒ½ä¿æŒè‡ªèº«MPçš„å……è£•ï¼Œä¸ºåç»­çš„æˆ˜æ–—åšå¥½å‡†å¤‡ã€‚
âš”ï¸ [é˜¿å°”æ‰˜è‰é›…Â·æ½˜å¾·æ‹‰è´¡ çš„è¡ŒåŠ¨]: é£ç‹ç»“ç•ŒÂ·è¿…æ·æ–©å‡»
ë¬˜ [é˜¿å°”æ‰˜è‰é›…çš„çœ¼ç¥åšå®šï¼Œå¥¹å‡­å€Ÿå¯¹é£ç‹ç»“ç•Œçš„ç²¾å¦™æ“æ§ï¼Œå°†åœ£å‰‘å®Œå…¨éšåŒ¿äºæ‰­æ›²çš„å…‰çº¿ä¹‹åã€‚å¥¹èº«å½¢å¦‚é£èˆ¬è¿…æ·ï¼Œåœ¨Rå°šæœªå®Œå…¨ååº”è¿‡æ¥ä¹‹é™…ï¼Œåœ£å‰‘å¸¦ç€æ— å½¢çš„å‡Œå‰ä¹‹åŠ¿ï¼Œåˆ’ç ´ç©ºæ°”ï¼Œç›´å–å…¶èº«ã€‚è¿™ä¸€å‡»æ— å£°æ— æ¯ï¼Œå´è•´å«ç€éª‘å£«ç‹çº¯ç²¹çš„åŠ›é‡ä¸ç²¾å‡†ã€‚]
--- ç¬¬ 3 å›åˆ ---

[ç³»ç»Ÿ] æ­£åœ¨ä¸º R æ€è€ƒè¡ŒåŠ¨...
ğŸ§  [R çš„æƒ³æ³•]: é˜¿å°”æ‰˜è‰é›…çš„â€œé£ç‹ç»“ç•Œâ€è®©å¥¹çš„æ”»å‡»éš¾ä»¥é¢„æµ‹ï¼ŒRåœ¨ä¸Šä¸€å›åˆå› æ­¤å—äº†ä¼¤ã€‚ç›´æ¥çš„æ”»å‡»å¯èƒ½å†æ¬¡è¢«éšå½¢æ•ˆæœè§„é¿ï¼Œè€Œå•çº¯é˜²å¾¡ä¹Ÿæ— æ³•è§£å†³æ ¸å¿ƒé—®é¢˜ã€‚Rå†³å®šåˆ©ç”¨ä»–å†°å±æ€§é­”æ³•çš„â€œæ§åœºâ€èƒ½åŠ›å’Œå¯¹æ°´æ±½çš„ç²¾å¦™æ“æ§ï¼Œåˆ¶é€ ä¸€åœºå†°éœœè¿·é›¾ã€‚è¿™ä¸ä»…èƒ½é˜»ç¢å¯¹æ–¹è§†çº¿ï¼Œæ›´å…³é”®çš„æ˜¯ï¼Œä»–å¸Œæœ›é€šè¿‡å¯†é›†çš„å†°æ™¶å¹²æ‰°ç”šè‡³æš‚æ—¶ç ´é™¤â€œé£ç‹ç»“ç•Œâ€å¯¹å…‰çº¿çš„æ‰­æ›²æ•ˆæœï¼Œä»è€Œæ­ç¤ºåœ£å‰‘çš„çœŸæ­£ä½ç½®ï¼Œä¸ºæ¥ä¸‹æ¥çš„åå‡»åˆ›é€ æœºä¼šã€‚è¿™ç¬¦åˆä»–å¿«é€Ÿå­¦ä¹ å’Œé€‚åº”çš„ç‰¹æ€§ï¼Œå¹¶ä¸”ä¸ç›´æ¥ä¾èµ–äºä¼¤å®³è¾“å‡ºï¼Œé¿å…äº†é˜¿å°”æ‰˜è‰é›…çš„â€œå¯¹é­”åŠ›â€æŠ—æ€§ã€‚MPæ¶ˆè€—20æ˜¯åˆç†çš„æˆ˜æœ¯æŠ€èƒ½æ¶ˆè€—ã€‚
âš”ï¸ [R çš„è¡ŒåŠ¨]: å†°éœœè¿·é›¾
ë¬˜ [Rçš„çœ¼ç¥å˜å¾—æ·±é‚ƒï¼Œä»–æ·±å¸ä¸€å£æ°”ï¼Œå‘¨å›´ç©ºæ°”ä¸­çš„æ°´æ±½ä»¿ä½›è¢«æ— å½¢çš„åŠ›é‡ç‰µå¼•ï¼Œè¿…é€Ÿå‡èšå¹¶æé€Ÿå†·å´ã€‚ä¸€è‚¡å¸¦ç€å½»éª¨å¯’æ„çš„æµ“å¯†å†°éœœè¿·é›¾ä»¥Rä¸ºä¸­å¿ƒè¿…é€Ÿæ‰©æ•£ï¼Œç¬¼ç½©äº†å…¬å›­çš„ä¸€éƒ¨åˆ†åŒºåŸŸã€‚è¿™è¿·é›¾ä¸ä»…é˜»ç¢è§†çº¿ï¼Œæ›´è¯•å›¾ä»¥å…¶å¯†é›†çš„å†°æ™¶å¹²æ‰°é£ç‹ç»“ç•Œå¯¹å…‰çº¿çš„æ‰­æ›²ï¼ŒæœŸæœ›èƒ½è®©é˜¿å°”æ‰˜è‰é›…çš„åœ£å‰‘æ˜¾éœ²å‡ºå“ªæ€•ä¸€ä¸è½®å»“ã€‚]
--- ç¬¬ 4 å›åˆ ---

[ç³»ç»Ÿ] æ­£åœ¨ä¸º é˜¿å°”æ‰˜è‰é›…Â·æ½˜å¾·æ‹‰è´¡ æ€è€ƒè¡ŒåŠ¨...
ğŸ§  [é˜¿å°”æ‰˜è‰é›…Â·æ½˜å¾·æ‹‰è´¡ çš„æƒ³æ³•]: Rçš„å†°éœœè¿·é›¾è¯•å›¾å¹²æ‰°é£ç‹ç»“ç•Œå¹¶æš´éœ²åœ£å‰‘ã€‚é˜¿å°”æ‰˜è‰é›…ä½œä¸ºä¸€åç›´ç‡ä¸”å¼ºå¤§çš„éª‘å£«ï¼Œä¸ä¼šè¢«è¿™ç§æ§åœºä¼ä¿©æ‰€å›°æ‰°ã€‚ç›¸åï¼Œå¥¹å°†Rçš„è¡ŒåŠ¨è§†ä¸ºä¸€ä¸ªä½¿ç”¨å®å…·çš„ä¿¡å·ã€‚å®å…·â€œèª“çº¦èƒœåˆ©ä¹‹å‰‘â€æ˜¯å…‰ä¹‹æ´ªæµï¼Œå…¶å¼ºå¤§çš„å…‰èŠ’å’Œå†²å‡»åŠ›èƒ½å¤Ÿå®Œå…¨ç©¿é€æˆ–è’¸å‘å†°é›¾ï¼Œä»è€Œå®Œç¾å…‹åˆ¶Rçš„é˜²å¾¡æ€§ç­–ç•¥ã€‚åŒæ—¶ï¼ŒRçš„HPå·²ç»å—æŸï¼Œæ­¤æ—¶é‡Šæ”¾é«˜ä¼¤å®³å®å…·å¯ä»¥äº‰å–ä¸€å‡»å®šèƒœè´Ÿçš„æœºä¼šï¼Œé¿å…Råˆ©ç”¨â€œæå¯’è‡ªæ„ˆâ€æ¢å¤ã€‚é˜¿å°”æ‰˜è‰é›…æ‹¥æœ‰è¶³å¤Ÿçš„MPæ¥é‡Šæ”¾å®å…·ï¼Œè¿™æ˜¯å½“å‰æœ€æœ‰æ•ˆç‡ä¸”æœ€å…·å†³å®šæ€§çš„è¡ŒåŠ¨ã€‚
âš”ï¸ [é˜¿å°”æ‰˜è‰é›…Â·æ½˜å¾·æ‹‰è´¡ çš„è¡ŒåŠ¨]: èª“çº¦èƒœåˆ©ä¹‹å‰‘
ë¬˜ [é˜¿å°”æ‰˜è‰é›…æ„Ÿå—ç€Rå‘¨å›´å†°éœœè¿·é›¾çš„é­”åŠ›æ³¢åŠ¨ï¼Œå˜´è§’å¾®å¾®ä¸Šæ‰¬ã€‚å¥¹æ˜ç™½Rè¯•å›¾é€šè¿‡å¹²æ‰°é£ç‹ç»“ç•Œæ¥çª¥æ¢åœ£å‰‘çš„çœŸè²Œã€‚ç„¶è€Œï¼Œè¿™æ°æ°ä¸ºå¥¹æä¾›äº†ä¸€ä¸ªç»ä½³çš„æœºä¼šã€‚å¥¹ä¸å†å‹æŠ‘åœ£å‰‘ä¸­æ¶ŒåŠ¨çš„é­”åŠ›ï¼Œå°†â€œé£ç‹ç»“ç•Œâ€ç¬é—´è§£é™¤ï¼Œç’€ç’¨çš„é‡‘å…‰éª¤ç„¶å†²ç ´è¿·é›¾ï¼Œç…§äº®äº†æ•´ä¸ªå…¬å›­ã€‚å¥¹ä¸¾èµ·å®Œå…¨æ˜¾ç°çš„åœ£å‰‘ï¼Œå°†æ±‡èšçš„é­”åŠ›åŒ–ä½œä¸€é“ç‚½çƒ­çš„å…‰ä¹‹æ´ªæµï¼Œä¼´éšç€â€œExcaliburï¼â€çš„åº„ä¸¥å®£å‘Šï¼Œæ’•è£‚å†°é›¾ï¼Œç›´å†²Rè€Œå»ï¼Œèª“è¦å°†ä¸€åˆ‡éšœç¢ä¸æ•Œäººå°½æ•°æ–©ç­ã€‚]

--- æ¨¡æ‹Ÿç»“æŸ ---

Process finished with exit code 0

"""
